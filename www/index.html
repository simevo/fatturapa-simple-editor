<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8">
    <title>FatturaPA simple editor</title>
    <script type="text/javascript" src="js/vue.min.js"></script>
    <script type="text/javascript" src="js/validate.js"></script>
    <script type="text/javascript" src="js/handlebars.min.js"></script>
  </head>
  <body>
    <h2>FatturaPA simple editor</h2>
    <a href="https://github.com/simevo/fatturapa-simple-editor">https://github.com/simevo/fatturapa-simple-editor</a>
    <hr/>

<div id="page:main-container">

<form method="post" action='<?php echo $mUrl; ?>'>

<div class="content-header">
    <table cellspacing="0">
        <tbody><tr>
            <td style="width:50%;"><h3 class="icon-head head-sales-invoice"><?php echo "Fattura " . $fId ?> </h3></td>
            <td class="form-buttons"><button  type="submit" class="scalable save" style=""><span><span><span>Genera Fattura Elettronica</span></span></span></button></td>
        </tr>
    </tbody></table>
</div>


<input name="form_key" type="hidden" value='<?php echo $fKey ?>' />

<div id="fattura"  class="box">
    <!--Order Information-->
    <div class="entry-edit">
        <div class="entry-edit-head">
            <strong>Dati Trasmissione</strong>
        </div>
        <div class="fieldset">
            <table cellspacing="0" class="form-list">
            <tbody>
            <tr>
                <td class="label"><label>Id paese</label></td>
                <td class="value">
                <select :select="FatturaElettronica.FatturaElettronicaHeader.DatiTrasmissione.IdTrasmittente.IdPaese">
                <?php foreach ($countryList as $c => $ca) { ?>
                <option <?php if($ca['value'] == 'IT') echo 'selected="selected"' ?> value="<?php echo $ca['value']; ?>"><?php echo $ca['value']; ?></option>
                <?php } ?>
				</td>
            </tr>
            <tr>
                <td class="label"><label>Id codice</label></td>
                <td class="value"><input type="text" :value="FatturaElettronica.FatturaElettronicaHeader.DatiTrasmissione.IdTrasmittente.IdCodice"></td>
            </tr>
            <tr>
                <td class="label"><label>Progressivo Invio</label></td>
                <td class="value"><input type="text" :value="FatturaElettronica.FatturaElettronicaHeader.DatiTrasmissione.ProgressivoInvio"></td>
            </tr>
            <tr>
                <td class="label"><label>Formato Trasmissione</label></td>
                <td class="value"><input type="text" :value="FatturaElettronica.FatturaElettronicaHeader.DatiTrasmissione.FormatoTrasmissione"></td>
            </tr>
            <tr>
                <td class="label"><label>Codice Destinatario</label></td>
                <td class="value"><input type="text" :value="FatturaElettronica.FatturaElettronicaHeader.DatiTrasmissione.CodiceDestinatario"></td>
            </tr>
            </tbody></table>
        </div>
    </div>

    <!-- cedente prestatore from config -->
    <?php foreach ($config as $key => $fields) { ?>
    <div class="entry-edit">
        <div class="entry-edit-head">
            <strong><?php echo $key?></strong>
        </div>
        <div class="fieldset">
            <table cellspacing="0" class="form-list">
            <tbody>
			<?php foreach ($fields as $field => $value) { ?>
			<tr>
                <td class="label"><label><?php echo $field ?></label></td>
                <td class="value"><input type="text" name="<?php echo $key . '_' . $field ?>" value="<?php echo $value ?>"></td>
            </tr>
			<?php } ?>
	</tbody></table>
        </div>
    </div>
	<?php } ?>


    <div class="entry-edit">
        <div class="entry-edit-head">
            <strong>Cessionario Committente - Dati Anagrafici - Id Fiscale IVA</strong>
        </div>
        <div class="fieldset">
            <table cellspacing="0" class="form-list">
            <tbody><tr>
                <td class="label"><label>Id Paese</label></td>
                <td class="value">
                <select name="CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdPaese">
                <?php foreach ($countryList as $c => $ca) { ?>
                <option <?php if($ca['value'] == 'IT') echo 'selected="selected"' ?> value="<?php echo $ca['value']; ?>"><?php echo $ca['value']; ?></option>
                <?php } ?>
				</td>
            </tr>
            <tr>
                <td class="label"><label>Id Codice</label></td>
                <td class="value"><input type="text" name="CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdCodice"></td>
            </tr>
            </tbody></table>
        </div>
    </div>

    <div class="entry-edit">
        <div class="entry-edit-head">
            <strong>Cessionario Committente - Dati Anagrafici - Anagrafica</strong>
        </div>
        <div class="fieldset">
            <table cellspacing="0" class="form-list">
            <tbody><tr>
                <td class="label"><label>Denominazione</label></td>
                <td class="value"><input type="text" name="CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione" value="<?php echo $cc['company'] ?>"></td>
            </tr>
            <tr>
                <td class="label"><label>Nome</label></td>
                <td class="value"><input type="text" name="CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome" value="<?php echo $cc['firstname'] ?>"></td>
            </tr>
            <tr>
                <td class="label"><label>Cognome</label></td>
                <td class="value"><input type="text" name="CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome" value="<?php echo $cc['lastname'] ?>"></td>
            </tr>
            </tbody></table>
        </div>
    </div>

        <div class="entry-edit">
        <div class="entry-edit-head">
            <strong>Cessionario Committente - Sede</strong>
        </div>
        <div class="fieldset">
            <table cellspacing="0" class="form-list">
            <tbody><tr>
                <td class="label"><label>Indirizzo</label></td>
                <td class="value"><input type="text" name="CessionarioCommittente_Sede_Indirizzo" value="<?php echo $cc['street'] ?>"></td>
            </tr>
            <tr>
                <td class="label"><label>CAP</label></td>
                <td class="value"><input type="text" name="CessionarioCommittente_Sede_CAP" value="<?php echo $cc['postcode'] ?>"></td>
            </tr>
            <tr>
                <td class="label"><label>Comune</label></td>
                <td class="value"><input type="text" name="CessionarioCommittente_Sede_Comune" value="<?php echo $cc['city'] ?>"></td>
            </tr>
            <tr>
                <td class="label"><label>Nazione</label></td>
                <td class="value"><input type="text" name="CessionarioCommittente_Sede_Nazione" value="<?php echo $cc['country_id'] ?>"></td>
            </tr>
            </tbody></table>
        </div>
    </div>

    <div class="entry-edit">
        <div class="entry-edit-head">
            <strong>Dati Generali - Dati Generali Documento</strong>
        </div>
        <div class="fieldset">
            <table cellspacing="0" class="form-list">
            <tbody><tr>
                <td class="label"><label>Tipo Documento</label></td>
                <td class="value"><input type="text" name="DatiGenerali_DatiGeneraliDocumento_TipoDocumento">
				<p class="note">tipologia del documento oggetto della trasmissione (fattura, acconto/anticipo su fattura, nota di credito, parcella â€¦).</p>
                </td>
            </tr>
            <tr>
                <td class="label"><label>Divisa</label></td>
                <td class="value">
                <select name="DatiGenerali_DatiGeneraliDocumento_Divisa">
                <?php foreach ($currencies as $s => $d) { ?>
                <option <?php if($s == "EUR") echo "selected='selected' " ?> value="<?php echo $s ?>"><?php echo $d ?></option>
                <?php } ?>
				</select>
            </tr>
            <tr>
                <td class="label"><label>Data</label></td>
                <td class="value"><input type="text" name="DatiGenerali_DatiGeneraliDocumento_Data" id="DatiGenerali_DatiGeneraliDocumento_Data"></td>
            </tr>
            <tr>
                <td class="label"><label>Numero</label></td>
                <td class="value"><input type="text" name="DatiGenerali_DatiGeneraliDocumento_Numero"></td>
            </tr>
            </tbody></table>
        </div>
    </div>

    <button type="button" v-on:click="generateJson();">Genera JSON</button>
    <button type="button" v-on:click="generateXml();">Genera XML</button>
    <button type="button" v-on:click="validateJson();">Valida JSON</button>    

<!-- end page -->    
</div>

<!-- outside #fattura to avoid JSON circularity -->
<input id="json" name="json" type="text" />
<input id="xml" name="xml" type="text" />
<input id="result" name="result" type="text" />

</form>
</div>

<script type="text/javascript">
    // configuration for jshint
    /* jshint browser: true, devel: true */
    /* global Vue, Handlebars, jsonSchema */
    
    "use strict";
    
    var app = new Vue({
      el: '#fattura',
      created: function () {
          // TODO ?
      },
      data: {
        // sample data from fattura-elettronica-json/samples/IT01234567890_FPA01-js.json
        "FatturaElettronica": {
            "versione": "FPA12",
            "FatturaElettronicaHeader": {
            "DatiTrasmissione": {
                "IdTrasmittente": {
                "IdPaese": "IT",
                "IdCodice": "01234567890"
                },
                "ProgressivoInvio": "00001",
                "FormatoTrasmissione": "FPA12",
                "CodiceDestinatario": "AAAAAA"
            },
            "CedentePrestatore": {
                "DatiAnagrafici": {
                "IdFiscaleIVA": {
                    "IdPaese": "IT",
                    "IdCodice": "01234567890"
                },
                "Anagrafica": {
                    "Denominazione": "ALPHA SRL"
                },
                "RegimeFiscale": "RF19"
                },
                "Sede": {
                "Indirizzo": "VIALE ROMA 543",
                "CAP": "07100",
                "Comune": "SASSARI",
                "Provincia": "SS",
                "Nazione": "IT"
                }
            },
            "CessionarioCommittente": {
                "DatiAnagrafici": {
                "CodiceFiscale": "09876543210",
                "Anagrafica": {
                    "Denominazione": "AMMINISTRAZIONE BETA"
                }
                },
                "Sede": {
                "Indirizzo": "VIA TORINO 38-B",
                "CAP": "00145",
                "Comune": "ROMA",
                "Provincia": "RM",
                "Nazione": "IT"
                }
            }
            },
            "FatturaElettronicaBody": [
            {
                "DatiGenerali": {
                "DatiGeneraliDocumento": {
                    "TipoDocumento": "TD01",
                    "Divisa": "EUR",
                    "Data": "2017-01-18",
                    "Numero": "123",
                    "Causale": [
                    "LA FATTURA FA RIFERIMENTO AD UNA OPERAZIONE AAAA BBBBBBBBBBBBBBBBBB CCC DDDDDDDDDDDDDDD E FFFFFFFFFFFFFFFFFFFF GGGGGGGGGG HHHHHHH II LLLLLLLLLLLLLLLLL MMM NNNNN OO PPPPPPPPPPP QQQQ RRRR SSSSSSSSSSSSSS",
                    "SEGUE DESCRIZIONE CAUSALE NEL CASO IN CUI NON SIANO STATI SUFFICIENTI 200 CARATTERI AAAAAAAAAAA BBBBBBBBBBBBBBBBB"
                    ]
                },
                "DatiOrdineAcquisto": [
                    {
                    "RiferimentoNumeroLinea": [
                        "1"
                    ],
                    "IdDocumento": "66685",
                    "NumItem": "1",
                    "CodiceCUP": "123abc",
                    "CodiceCIG": "456def"
                    }
                ],
                "DatiContratto": [
                    {
                    "RiferimentoNumeroLinea": [
                        "1"
                    ],
                    "IdDocumento": "123",
                    "Data": "2016-09-01",
                    "NumItem": "5",
                    "CodiceCUP": "123abc",
                    "CodiceCIG": "456def"
                    }
                ],
                "DatiConvenzione": [
                    {
                    "RiferimentoNumeroLinea": [
                        "1"
                    ],
                    "IdDocumento": "456",
                    "NumItem": "5",
                    "CodiceCUP": "123abc",
                    "CodiceCIG": "456def"
                    }
                ],
                "DatiRicezione": [
                    {
                    "RiferimentoNumeroLinea": [
                        "1"
                    ],
                    "IdDocumento": "789",
                    "NumItem": "5",
                    "CodiceCUP": "123abc",
                    "CodiceCIG": "456def"
                    }
                ],
                "DatiTrasporto": {
                    "DatiAnagraficiVettore": {
                    "IdFiscaleIVA": {
                        "IdPaese": "IT",
                        "IdCodice": "24681012141"
                    },
                    "Anagrafica": {
                        "Denominazione": "Trasporto spa"
                    }
                    },
                    "DataOraConsegna": "2017-01-10T16:46:12.000+02:00"
                }
                },
                "DatiBeniServizi": {
                "DettaglioLinee": [
                    {
                    "NumeroLinea": "1",
                    "Descrizione": "DESCRIZIONE DELLA FORNITURA",
                    "Quantita": "5.00",
                    "PrezzoUnitario": "1.00",
                    "PrezzoTotale": "5.00",
                    "AliquotaIVA": "22.00"
                    }
                ],
                "DatiRiepilogo": [
                    {
                    "AliquotaIVA": "22.00",
                    "ImponibileImporto": "5.00",
                    "Imposta": "1.10",
                    "EsigibilitaIVA": "I"
                    }
                ]
                },
                "DatiPagamento": [
                {
                    "CondizioniPagamento": "TP01",
                    "DettaglioPagamento": {
                    "ModalitaPagamento": "MP01",
                    "DataScadenzaPagamento": "2017-02-18",
                    "ImportoPagamento": "6.10"
                    }
                }
              ]
            }
          ]
        }
      },
      methods: {
        validateJson: function() {
            var request = new XMLHttpRequest();
            request.open("GET", "js/fatturaPA_1.2_schema.json");
            request.onload = function() {
                if (request.status == 200) {
                    if (request.responseText) {
                        var schema = request.responseText;
                        var json = JSON.stringify(this);
                        var result = jsonSchema.validate(json, schema);
                        document.getElementById("result").value = JSON.stringify(result);
                    }
                }
            };
            request.send();
        },
        generateJson: function() {
            var json = JSON.stringify(this.FatturaElettronica);
            console.log(json);
            document.getElementById("json").value = json;
        },
        generateXml: function() {
            var request = new XMLHttpRequest();
            request.open("GET", "js/fatturaPA_1.2.hbs");
            request.onload = function() {
                if (request.status == 200) {
                    if (request.responseText) {
                        var source = request.responseText;
                        var template = Handlebars.compile(source);
                        var context = this;
                        var xml = template(context);
                        document.getElementById("xml").value = xml;
                    }
                }
            };
            request.send();
        },
      }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log("DOM fully loaded and parsed");
    });
    
</script>    
</body>
</html>
